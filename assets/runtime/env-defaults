#!/bin/bash

DEBUG=${DEBUG:-$DEBUG_ENTRYPOINT}

MATTERMOST_NAME=${MATTERMOST_NAME:-Mattermost}

# Email settings
MATTERMOST_ENABLE_EMAIL_SIGNUP=${MATTERMOST_ENABLE_EMAIL_SIGNUP:-true}
MATTERMOST_SECRET_KEY=${MATTERMOST_SECRET_KEY:-}
MATTERMOST_RESET_SALT=${MATTERMOST_RESET_SALT:-}
MATTERMOST_INVITE_SALT=${MATTERMOST_INVITE_SALT:-}

# Service settings
MATTERMOST_SITE_URL=${MATTERMOST_SITE_URL:-}
MATTERMOST_MAX_LOGIN_ATTEMPTS=${MATTERMOST_MAX_LOGIN_ATTEMPTS:-10}
MATTERMOST_SEGMENT_KEY=${MATTERMOST_SEGMENT_KEY:-}
MATTERMOST_GOOGLE_KEY=${MATTERMOST_GOOGLE_KEY:-}
MATTERMOST_ENABLE_ADMIN_INTEGRATIONS=${MATTERMOST_ENABLE_ADMIN_INTEGRATIONS:-true}
MATTERMOST_ENABLE_SLASH_COMMANDS=${MATTERMOST_ENABLE_SLASH_COMMANDS:-false}
MATTERMOST_ENABLE_INCOMING_WEBHOOKS=${MATTERMOST_ENABLE_INCOMING_WEBHOOKS:-false}
MATTERMOST_ENABLE_OUTGOING_WEBHOOKS=${MATTERMOST_ENABLE_OUTGOING_WEBHOOKS:-false}
MATTERMOST_WEBHOOK_OVERRIDE_USERNAME=${MATTERMOST_WEBHOOK_OVERRIDE_USERNAME:-false}
MATTERMOST_WEBHOOK_OVERRIDE_ICON=${MATTERMOST_WEBHOOK_OVERRIDE_ICON:-false}
MATTERMOST_ENABLE_ALERTS=${MATTERMOST_ENABLE_ALERTS:-true}
MATTERMOST_ENABLE_INSECURE_CONNECTIONS=${MATTERMOST_ENABLE_INSECURE_CONNECTIONS:-false}
MATTERMOST_CORS_DOMAINS=${MATTERMOST_CORS_DOMAINS:-}
MATTERMOST_WEB_SESSION_DAYS=${MATTERMOST_WEB_SESSION_DAYS:-30}
MATTERMOST_MOBILE_SESSION_DAYS=${MATTERMOST_MOBILE_SESSION_DAYS:-30}
MATTERMOST_SSO_SESSION_DAYS=${MATTERMOST_SSO_SESSION_DAYS:-30}
MATTERMOST_SESSION_CACHE=${MATTERMOST_SESSION_CACHE:-10}
MATTERMOST_WEBSERVER_MODE=${MATTERMOST_WEBSERVER_MODE:-gzip}
MATTERMOST_ENABLE_CUSTOM_EMOJI=${MATTERMOST_ENABLE_CUSTOM_EMOJI:-true}
MATTERMOST_RESTRICT_DIRECT_MESSAGE=${MATTERMOST_RESTRICT_DIRECT_MESSAGE:-any}

# Team settings
MATTERMOST_MAX_USERS=${MATTERMOST_MAX_USERS:-50}
MATTERMOST_CREATE_TEAMS=${MATTERMOST_CREATE_TEAMS:-true}
MATTERMOST_CREATE_USERS=${MATTERMOST_CREATE_USERS:-true}
MATTERMOST_USER_DOMAINS=${MATTERMOST_USER_DOMAINS:-}
MATTERMOST_OPEN_SERVER=${MATTERMOST_OPEN_SERVER:-false}

# Mail settings
MATTERMOST_EMAIL_SIGNIN=${MATTERMOST_EMAIL_SIGNIN:-true}
MATTERMOST_USERNAME_SIGNIN=${MATTERMOST_USERNAME_SIGNIN:-false}

# Push notifications
MATTERMOST_PUSH_SERVER=${MATTERMOST_PUSH_SERVER:-}
if [[ -z ${MATTERMOST_PUSH_SERVER} ]]; then
  MATTERMOST_ENABLE_PUSH_NOTIFICATIONS=false
fi
MATTERMOST_ENABLE_PUSH_NOTIFICATIONS=${MATTERMOST_ENABLE_PUSH_NOTIFICATIONS:-true}

MATTERMOST_PUSH_FULL_MESSAGE=${MATTERMOST_PUSH_FULL_MESSAGE:-false}
if [[ ${MATTERMOST_PUSH_FULL_MESSAGE} ]];then
  MATTERMOST_PUSH_CONTENTS=full
else
  MATTERMOST_PUSH_CONTENTS=generic
fi

# Storage settings
MATTERMOST_LINK_SALT=${MATTERMOST_LINK_SALT:-}
if [[ -z $MATTERMOST_LINK_SALT} ]]; then
  MATTERMOST_ENABLE_PUBLIC_LINKS=false
fi
MATTERMOST_ENABLE_PUBLIC_LINKS=${MATTERMOST_ENABLE_PUBLIC_LINKS:-true}
MATTERMOST_MAX_FILE_SIZE=${MATTERMOST_MAX_FILE_SIZE:-52428800}

# Rate limit settings
MATTERMOST_ENABLE_RATE_LIMIT=${MATTERMOST_ENABLE_RATE_LIMIT:-true}
MATTERMOST_RATE_LIMIT_QPS=${MATTERMOST_RATE_LIMIT_QPS:-10}
MATTERMOST_RATE_LIMIT_SESSIONS=${MATTERMOST_RATE_LIMIT_SESSIONS:-10000}
MATTERMOST_RATE_LIMIT_BY_IP=${MATTERMOST_RATE_LIMIT_BY_IP:-true}
MATTERMOST_RATE_LIMIT_HEADERS=${MATTERMOST_RATE_LIMIT_HEADERS:-}

# Privacy settings
MATTERMOST_SHOW_EMAIL=${MATTERMOST_SHOW_EMAIL:-true}
MATTERMOST_SHOW_NAME=${MATTERMOST_SHOW_NAME:-true}

# Localization
MATTERMOST_SERVER_LOCALE=${MATTERMOST_SERVER_LOCALE:-en}
MATTERMOST_CLIENT_LOCALE=${MATTERMOST_CLIENT_LOCALE:-en}
MATTERMOST_LOCALES=${MATTERMOST_LOCALES:-en,es,fr,ja,pt-BR}

# Database settings
DB_ADAPTER=${DB_ADAPTER:-}
DB_HOST=${DB_HOST:-}
DB_PORT=${DB_PORT:-}
DB_USER=${DB_USER:-}
DB_PASS=${DB_PASS:-}
DB_NAME=${DB_NAME:-}
DB_ENCODING=${DB_ENCODING:-}
MATTERMOST_DATASOURCE=

# SMTP settings
SMTP_HOST=${SMTP_HOST:-}
SMTP_PORT=${SMTP_PORT:-25}
SMTP_USER=${SMTP_USER:-}
SMTP_PASS=${SMTP_PASS:-}
SMTP_SECURITY=${SMTP_SECURITY:-}
MATTERMOST_EMAIL=${MATTERMOST_EMAIL:-${SMTP_USER}}
MATTERMOST_EMAIL=${MATTERMOST_EMAIL:-example@example.com}
MATTERMOST_SUPPORT_EMAIL=${MATTERMOST_SUPPORT_EMAIL:-support@example.com}
if [[ -z ${SMTP_HOST} ]]; then
  MATTERMOST_EMAIL_NOTIFICATIONS=false
  MATTERMOST_EMAIL_VERIFICATION=false
fi
MATTERMOST_EMAIL_NOTIFICATIONS=${MATTERMOST_EMAIL_NOTIFICATIONS:-true}
MATTERMOST_EMAIL_VERIFICATION=${MATTERMOST_EMAIL_VERIFICATION:-true}

if [[ -z ${MATTERMOST_SITE_URL} ]]; then
  MATTERMOST_ENABLE_EMAIL_BATCHING=false
fi
MATTERMOST_ENABLE_EMAIL_BATCHING=${MATTERMOST_ENABLE_EMAIL_BATCHING:-${MATTERMOST_EMAIL_NOTIFICATIONS}}

# GitLab settings
GITLAB_SECRET=${GITLAB_SECRET:-}
GITLAB_ID=${GITLAB_ID:-}
GITLAB_SCOPE=${GITLAB_SCOPE:-}
GITLAB_AUTH_ENDPOINT=${GITLAB_AUTH_ENDPOINT:-}
GITLAB_TOKEN_ENDPOINT=${GITLAB_TOKEN_ENDPOINT:-}
GITLAB_API_ENDPOINT=${GITLAB_API_ENDPOINT:-}
if [[ -z ${GITLAB_ID} ]]; then
  GITLAB_ENABLE=false
fi
GITLAB_ENABLE=${GITLAB_ENABLE:-true}
